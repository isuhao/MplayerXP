#!/bin/bash
# query full-featured shell here
#
# Original version (C) 2000 Pontscho/fresh!mindworkz
#                      pontscho@makacs.poliod.hu
#
# History / Contributors: check the cvs log !
#
# Cleanups all over the place (c) 2001 pl
#
#
# Guidelines:
# If the option is named 'opt':
#   _opt : should have a value in yes/no/auto
#   _def_opt : '#define ... 1' or '#undef ...' that is: some C code
#   _ld_opt : ' -L/path/dir -lopt ' that is: some GCC option
#   _inc_opt : ' -I/path/dir/include '
#
# In this file, a tab is 8 chars and indentation shift is 2 characters
#
# GOTCHAS:
#  - config files are currently:
#    mpxp_config.h mpxp_config.mak
#
#############################################################################
. ../functions
init_functions

cd nls
LANGUAGES=`echo mpxp_help-??.h | sed "s/mpxp_help-\(..\).h/\1/g"`
cd ..
linguas=`echo $LANG | sed 's/^\([^_]*\).*$/\1/'`
test -z $linguas && linguas=en

# GOTCHA: the variables below defines the default behavior for autodetection
# and have - unless stated otherwise - at least 2 states : yes no
# If autodetection is available then the third state is: auto
ENABLED_LIST=(
    "shared|build shared libraries",
    "gomp|use GNU OpenMP (requires gcc-4.3+)",
    "gpl_only|build only GPL code",
    "fastcall|use regparm method on x86 systems",
    "fastmemcpy|use 3dnow/sse/mmx optimized memcpy()",
    "streaming|build with network support (http/mms/rtp)",
    "af_inet6|build with support for IPv6 protocol",
    "termcap|build with termcap database for key codes|http://www.catb.org/~esr/terminfo",
    "termios|build with termios database for key codes|http://www.catb.org/~esr/terminfo",
    "shm|build with shared memory if possible",
    "rtc|use RTC (/dev/rtc) on Linux",
    "iconv|build with iconv for encoding conversion|http://www.gnu.org/software/libiconv",
    "winsock2|use winsock2.h if possible",
    "largefiles|enable support for files > 2GB",
    "ossaudio|build with OSS audio output",
    "audio_select|use select() on OSS audio device",
    "alsa|build with ALSA audio output|http://www.alsa-project.org",
    "arts|build with ARTS audio output|http://www.arts-project.org",
    "esd|build with ESD audio ouput|ftp://ftp.gnome.org/pub/gnome/sources/esound",
    "openal|build with OpenAL audio output|http://connect.creativelabs.com/openal/default.aspx",
    "nas|build with NAS uadio output|http://nas.sourceforge.net",
    "jack|build with JACK audio output|http://jackaudio.org",
    "libcdio|build with libcdio support|http://www.gnu.org/software/libcdio/index.html",
    "x11|build with X11 video ouput|http://www.x.org",
    "xv|build with Xv video output|http://www.x.org",
    "fbdev|build with FBDev video ouput",
    "jpg|build with JPEG for screenshots|http://www.ijg.org",
    "png|build with PNG for screenshots|http://www.libpng.org/pub/png/libpng.html",
    "opengl|build with OpenGL video output|http://mesa3d.org",
    "vesa|build with VESA video output",
    "vidix|build with VIDIX video output|http://vidix.sourceforge.net",
    "xdpms|build with X11 DPMS support|http://www.x.org",
    "xinerama|build with X11 Xinerama support|http://www.x.org",
    "xf86vm|build with X11 XF86Vm support|http://www.x.org",
    "tv|build wuth TV Interface (tv/dvb grabbers)",
    "tv_v4l|build with Video 4 Linux TV Interface support",
    "lirc|build with LIRC (remote control) support|http://www.lirc.org",
    "lircc|build with LIRCC (remote daemon control) support|http://www.lirc.org",
    "joystick|build with joystick support",
    "libdvdread|build with libdvdread support|http://www.dtek.chalmers.se/groups/dvd/downloads.shtml",
    "libdvdnav|build with libdvdnav support|http://dvd.sourceforge.net",
    "libdv|build with libdv support|http://libdv.sourceforge.net/",
    "libvcd|build with libvcd support|http://www.gnu.org/software/vcdimager",
    "libtheora|build with libtheora support|http://www.theora.org",
    "libbz2|build with libbz2 support|http://www.bzip.org"
)
DISABLED_LIST=(
    "gcov|compile gnu coverage information into PROGRAM",
    "profile|compile profiling information into PROGRAM",
    "static|build static libraries",
    "dbg23|allow additional level of debug messages",
    "win32loader|build support for Win32 codecs",
    "random_name|generates pseudo random suffix of target",
    "sdl|build with SDL video and audio output|http://www.libsdl.org",
    "sdl_image|build with SDL_image for screenshots|http://www.libsdl.org/projects/SDL_image",
    "libvorbis|build with libvorbis support|http://www.vorbis.com",
)

AUTOCONF_LIST=(
    "ENABLED_LIST",
    "DISABLED_LIST"
)

PATH_LIST=(
    "prefix|architecture-independent files|/usr/local",
    "exec_prefix|architecture-dependent files|\$prefix",
    "bindir|user executables|\$exec_prefix/bin",
    "libdir|object code libraries|\$exec_prefix/lib",
    "datadir|read-only architecture-independent data|\$prefix/share/mplayerxp",
    "confdir|read-only configuration files|\$prefix/share/mplayerxp",
    "win32libdir|win32 .dll locations [/usr/lib/win32]"
)

PROGNAME_LIST=(
  "program_prefix|prepend PREFIX to installed program names",
  "program_suffix|append SUFFIX to installed program names",
  "program_transform_name|use TRANSFORM_NAME as program name|mplayerxp"
)

SYSTYPES_LIST=(
    "build|configure for building on BUILD [guessed]",
    "host|cross-compile to build program to run on HOST [BUILD]",
    "cc|use this C compiler to build PROGRAM|gcc",
    "cxx|use this C++ compiler to build PROGRAM|g++",
    "as|use this ASSEMBLER to build PROGRAM|as",
    "ld|use this LINKER to build PROGRAM|gcc",
    "ldxx|use this LINKER to build PROGRAM with C++ sources|g++",
    "ldconfig|use this LDCONFIG to install PROGRAM|ldconfig",
    "install|use this INSTALL to install PROGRAM|install",
    "pkg_config|use this PKG-CONFIG to configure PROGRAM|pkg-config",
    "debug|compile debugging information into PROGRAM|0",
    "language|force this language as default for PROGRAM (Available: $LANGUAGES)|$linguas"
)

SYSCONF_LIST=(
    "SYSTYPES_LIST",
    "PROGNAME_LIST",
    "PATH_LIST"
)

EXTRA_LIST=(
    "asflags|add these FLAGS to [\$ASFLAGS=$ASFLAGS]",
    "cflags|add these FLAGS to [\$CFLAGS=$CFLAGS]",
    "cxxflags|add these FLAGS to [\$CXXFLAGS=$CXXFLAGS]",
    "ldflags|add these FLAGS to [\$LDFLAGS=$LDFLAGS]",
    "ldxxflags|add these FLAGS to [\$LDXXFLAGS=$LDXXFLAGS]",
    "extralibs|add these LIBS to [\$LIBS=$LIBS]"
)

ADD_LIST=(
    "EXTRA_LIST",
)

ENVIRONMENT_LIST=(
    "MAKE|Make command (example: 'make -j')|make",
    "AS|Assembler command|as",
    "CC|C compiler command (example: 'gcc -m64')|cc",
    "CXX|C++ compiler command (example: 'g++ -m64')|cxx",
    "CFLAGS|C compiler flags (example: '-funit-at-a-time')",
    "CXXFLAGS|C++ compiler flags (example: '-Weffc++')",
    "LDFLAGS|linker flags (example: '-L/opt/lib64')",
    "LDXXFLAGS|C++ linker flags (example: '-L/opt/lib64')",
    "LIBS|additional libraries (example: 'LIBS=-lacml_mv')",
    "DESTDIR|specifies base of installation"
)

HELP_LIST=(
    "PATH_LIST|Fine tuning of the installation directories|--",
    "PROGNAME_LIST|Program names|--",
    "SYSTYPES_LIST|System types|--",
    "EXTRA_LIST|Extralist|--",
    "ENABLED_LIST|Optional list of enabled fautures|--disable-",
    "DISABLED_LIST|Optional list of disabled fautures|--enable-",
    "ENVIRONMENT_LIST|Environment variables|  "
)

DEFAULT_LIST=(
    "PATH_LIST|Fine tuning of the installation directories|--",
    "SYSTYPES_LIST|System types|--",
    "PROGNAME_LIST|Program names|--",
    "EXTRA_LIST|Extralist|--"
)

enable_list "ENABLED_LIST"
disable_list "DISABLED_LIST"
make_environment "ENVIRONMENT_LIST"

for ac_option do
  optval="${ac_option#*=}"
  case "$ac_option" in
  --help)
    print_help "HELP_LIST"
    exit 0
    ;;
  --enable-*=*|--disable-*=*)
    eval $(echo "${ac_option%%=*}" | sed 's/--/action=/;s/-/ thing=/')
    in_list "AUTOCONF_LIST" ${thing} || bad_options="$ac_option $bad_options"
    if test "$action" = "disable"; then
      test "${optval}" = "no" && action=enable
    else
      test "${optval}" = "no" && action=disable
    fi
    $action ${thing}
    ;;

    --enable-?*|--disable-?*)
    eval $(echo "$ac_option" | sed 's/--/action=/;s/-/ thing=/;s/-/_/g')
    in_list "AUTOCONF_LIST" ${thing} || bad_options="$ac_option $bad_options"
    $action ${thing}
    ;;
    *)
    optname="${ac_option%%=*}"
    optname="${optname#--}"
    optname=${optname//-/_}
    if in_list "SYSCONF_LIST" $optname ; then
        eval $optname=$optval
    elif in_list "ADD_LIST" $optname ; then
	action="add_$optname"
	$action ${optval}
    else
        bad_options="$ac_option $bad_options"
    fi
    ;;
  esac
done
make_defaults "DEFAULT_LIST"
gas=`$cc -print-prog-name=as`
test -n $gas && as=$gas

mktmps
guess_target mpxp_config.mak mpxp_config.h

# config files

# FIXME: A lot of stuff is installed under /usr/local
# NK: But we should never use this stuff implicitly since we call compiler
# from /usr we should be sure that there no effects from other compilers
# (libraries) which might be installed into /usr/local.  Let users use this
# stuff explicitly as command line argument.  In other words: It would be
# resonable have or only /usr/include or only /usr/local/include.
enabled static && add_ldflags "-static"

if freebsd ; then
  add_ldflags "-L/usr/local/lib"
  add_cflags  "-I/usr/local/include"
fi
if cygwin ; then
  add_ldflags "-L/usr/bin"
fi

disable gcc44_workaround
# Checking CC version...
# gcc-3.0 merges optimizations coming from egcs, pgcc, agcc, ...
  echocheck "$cc version"
  # also check for name (the version checking is only for _gcc_ up for now)
  # FIXME implement this in ver. check.
  cc_name=`$cc -v 2>&1 | tail -n 1 | cut -d ' ' -f 1`
  cc_version=`$cc -dumpversion`
  cc_v=$cc_version
  case $cc_version in
    4.[4-9]|4.[4-9].[0-9])
      enable gcc44_workaround
      ;;
    3.[3-9]|3.[2-9].[3-9]|4.[0-3]|4.[0-3].[0-9])
      ;;
    *)
      die "*** Bad gcc-$cc_version: Please upgrade C compiler at least to gcc-3.2.3+! ***"
      ;;
  esac
  echores "$cc_version"
# now that we know what compiler should be used for compilation, try to find
# out which assembler is used by the $cc compiler
if cygwin ; then
prefix="."
fi

echocheck "whether the $cxx compiler works"
cat > $TMPC << EOF
#include <stdlib.h>
#include <malloc.h>
#include <new>

typedef void any_t;
enum alignedmemory_t{ alignmem=0 };
inline any_t* operator new(size_t size,const alignedmemory_t&,size_t boundary) {
    return memalign(boundary,size);
}
inline any_t* operator new[](size_t size,const alignedmemory_t&,size_t boundary) {
    return memalign(boundary,size);
}
inline void operator delete(any_t* p) { free(p); }

namespace mpxp {
    inline int funci(int i) { return i+2; }
}

using namespace mpxp;
int main(void) {
    char* cstr=new(alignmem,8) char [20];
    delete cstr;
    return funci(2);
}
EOF
cxx_check || die "no"

echocheck "Program name"
prog_alias=$program_transform_name
prog_alias="$program_prefix$prog_alias$program_suffix"
echores "$prog_alias"

# Atmos: moved this here, to be correct, if --prefix is specified
if cygwin ; then
# Keep everything in .exe folder
test -z "$datadir" && datadir="."
test -z "$confdir" && confdir="."
test -z "$libdir" && libdir="."
fi

srcdir=`pwd`
cd ..
topdir=`pwd`
cd $srcdir

#checking for pkg-config
test $($pkg_config --version 2>/dev/null) || die "no pkg-config found"
#############################################################################
enabled profile && disable fastcall
print_config __USE mpxp_config.h mpxp_config.mak fastcall

test_optimizations mpxp_config.mak mpxp_config.h

# Checking for GOMP
enabled gomp && check_ldflags -fopenmp || disable gomp
enabled gomp && require2 gomp omp.h omp_get_thread_num -lgomp || disable gomp
enabled gomp && check_cflags -fopenmp || disable gomp
print_config HAVE_ mpxp_config.h mpxp_config.mak gomp
#enabled gomp && check_cflags -ftree-parallelize-loops=4
#####################################################
add_cflags "-Warray-bounds -Wreturn-type -Wuninitialized -Wlogical-op -Waddress"
check_cflags "-W -Wall -Wextra"

echocheck CFLAGS
echores   $CFLAGS
echocheck CXXFLAGS
echores   $CXXFLAGS
echocheck ASFLAGS
echores   $ASFLAGS
echocheck LDFLAGS
echores   $LDFLAGS
echocheck LDXXFLAGS
echores   $LDXXFLAGS
echocheck LIBS
echores   $LIBS
echocheck extralibs
echores   $extralibs

######################
# MAIN TESTS GO HERE #
######################
add_cflags "-I$srcdir"


disable lavc
# Checking for LAVC
test -f "../lavc/libavcodec/avcodec.h" && enable lavc
disabled lavc && die "**FATAL**: local copy of lavc doesn't exist!"
add_cflags "-I$srcdir/../lavc"
print_config HAVE_ mpxp_config.h mpxp_config.mak lavc
# Configuring external lavc stuff
lavc_args="--enable-static --disable-shared --enable-gpl --enable-pthreads --disable-doc --disable-ffmpeg --disable-ffplay --disable-ffserver --disable-ffprobe --disable-avdevice --disable-avfilter --disable-avresample"
if test -n $host ; then
_arch=$host_arch
x86_32 && _arch="i686"
x86_64 && _arch="x86_64"
x86_32 && lavc_libsuffix="32"
x86_64 && lavc_libsuffix="64"
lavc_args="--arch=$_arch --build-suffix=$lavc_libsuffix $lavc_args"
fi
test "$debug" != "0" && lavc_args="$lavc_args --enable-debug=$debug"
enabled $profile  && lavc_args="$lavc_args --enable-profile"
if test -f "../lavc/libavcodec/libavcodec$lavc_libsuffix.a"; then
echocheck "lavc was already configured for $_arch"
else
echocheck "configuring lavc stuff: --cc=\"$cc\" $lavc_args"
cd ../lavc
$(LC_ALL=C ./configure --cc="$cc" $lavc_args)
cd $srcdir
fi
echores "done"
###################################

print_config ENABLE_ mpxp_config.h mpxp_config.mak gpl_only

check_header inttypes.h	|| die "cannot find header inttypes.h (see in DOC/faq.html)"

require2 libdl dlfcn.h dlsym -ldl ||  die "dynamic loader was not found"
print_config HAVE_ mpxp_config.h mpxp_config.mak libdl

require2 libkstat kstat.h kstat_open -lkstat
print_config HAVE_ mpxp_config.h mpxp_config.mak libkstat

require2 posix4 time.h nanosleep -lposix4
print_config HAVE_ mpxp_config.h mpxp_config.mak posix4

check_func2 time.h nanosleep
print_config HAVE_ mpxp_config.h mpxp_config.mak nanosleep

check_func2 execinfo.h backtrace
print_config HAVE_ mpxp_config.h mpxp_config.mak backtrace

disable inet_pton
if enabled streaming ; then
disable socklib
for ld_i in "" "-lsocket -lbind" "-lsocket -ldnet" "-lsocket -lnsl" "-lnsl" "-lsocket" ; do
disabled socklib	&& require3 socklib "netdb.h sys/socket.h" SOCK_STREAM gethostbyname $ld_i
enabled socklib	&& break
done
check_func2 "sys/types.h sys/socket.h arpa/inet.h" inet_pton
disabled inet_pton	&& require2 inet_pton "sys/types.h sys/socket.h arpa/inet.h" inet_pton -lresolv
# well, try alternative
if disabled inet_pton ; then
require2 aton "sys/types.h sys/socket.h arpa/inet.h" inet_aton
print_config USE_ mpxp_config.h mpxp_config.mak aton
fi
print_config HAVE_ mpxp_config.h mpxp_config.mak socklib

if enabled winsock2 && ! cygwin ; then
require2 winsock2 winsock2.h gethostbyname -lws2_32
print_config HAVE_ mpxp_config.h mpxp_config.mak winsock2
fi
fi #enabled streaming

disabled inet_pton	&& disable streaming
print_config HAVE_ mpxp_config.h mpxp_config.mak streaming
enabled streaming	&& inputmodules="streaming $inputmodules" || noinputmodules="streaming $noinputmodules"

disabled streaming	&& disable af_inet6

if enabled af_inet6 ; then
enabled winsock2	&& require3 af_inet6 ws2tcpip.h AF_INET6 socket
disabled winsock2	&& require3 af_inet6 "sys/socket.h netinet/in.h" AF_INET6 socket
print_config HAVE_ mpxp_config.h mpxp_config.mak af_inet6
fi

# find if .align arg is power-of-two or not
echocheck ".align is power-of-two"
cat > $TMPC << EOF
asm (".align 3");
EOF
asmalign_pot="no"
cc_check && asmalign_pot="yes"
echores $asmalign_pot
if test "$asmalign_pot" = "yes" ; then
  def_asmalign='#define ASMALIGN(ZEROBITS) ".align " #ZEROBITS "\n\t"'
else
  def_asmalign='#define ASMALIGN(ZEROBITS) ".align 1<<" #ZEROBITS "\n\t"'
fi

# find pagesize on this system
echocheck "VM pagesize is"
cat > $TMPC << EOF
#include <stdio.h>
#include <unistd.h>
int main(void) { printf("%i\n",getpagesize()); }
EOF
syspagesize="no"
cc_check && syspagesize="yes"
if enabled syspagesize ; then
vm_pagesize=`$TMPO`
else
vm_pagesize="1"
fi
echores "$vm_pagesize"

check_func3 _ISOC9X_SOURCE math.h lrint -lm
print_config HAVE_ mpxp_config.h mpxp_config.mak lrint

check_func3 _ISOC9X_SOURCE math.h llrint -lm
print_config HAVE_ mpxp_config.h mpxp_config.mak llrint

check_func3 _ISOC9X_SOURCE math.h HUGE -lm
print_config HAVE_ mpxp_config.h mpxp_config.mak HUGE

check_func2 "sys/types.h sys/mman.h" mmap
sys_mman_h=$mmap
print_config HAVE_ mpxp_config.h mpxp_config.mak sys_mman_h
enabled mmap	&& check_func2 "sys/mman.h" mlock
print_config HAVE_ mpxp_config.h mpxp_config.mak mlock

check_func2 "stdio.h stdarg.h" vsscanf
print_config HAVE_ mpxp_config.h mpxp_config.mak vsscanf

if enabled termcap; then
disable termcap
for ld_i in "-ltermcap" "-lncurses" "-ltinfo" ; do
disabled termcap	&& require2 termcap stdio.h tgetent $ld_i
enabled termcap	&& break
done
print_config HAVE_ mpxp_config.h mpxp_config.mak termcap
fi

if enabled termios; then
check_header sys/termios.h
print_config HAVE_ mpxp_config.h mpxp_config.mak sys_termios_h
disabled sys_termios_h	&& check_header termios.h 
disabled sys_termios_h	&& print_config HAVE_ mpxp_config.h mpxp_config.mak termios_h
fi

enabled shm	&& require2 shm "sys/types.h sys/shm.h" shmget
print_config HAVE_ mpxp_config.h mpxp_config.mak shm

require2 zlib zlib.h inflate -lz
print_config HAVE_ mpxp_config.h mpxp_config.mak zlib

if linux; then
enabled rtc	&& require2 rtc "sys/ioctl.h linux/rtc.h" RTC_IRQP_READ
print_config HAVE_ mpxp_config.h mpxp_config.mak rtc
fi

if enabled iconv; then
require2 giconv giconv.h iconv_open -lgiconv
print_config HAVE_ mpxp_config.h mpxp_config.mak giconv
disable iconv
for ld_i in "" -liconv ; do
disabled iconv	&& require2 iconv iconv.h iconv_open $ld_i
enabled iconv	&& break
done
print_config HAVE_ mpxp_config.h mpxp_config.mak iconv
fi

enabled lirc	&& require2 lirc lirc/lirc_client.h lirc_init -llirc_client
print_config HAVE_ mpxp_config.h mpxp_config.mak lirc

enabled lircc	&& require2 lircc lirc/lircc.h lircc_init -llircc
print_config HAVE_ mpxp_config.h mpxp_config.mak lircc

disable pthread
for ld_i in "-lpthreadGC2" "-lpthread" "-pthread" "" ; do
disabled pthread	&& require3 pthread "signal.h pthread.h" PTHREAD_COND_INITIALIZER pthread_kill $ld_i
enabled pthread	&& break
done
disabled pthread	&& die "Lib pthread not found. (needed by xp mode)"
print_config HAVE_ mpxp_config.h mpxp_config.mak pthread

check_func2 malloc.h malloc
disabled malloc		&& die "malloc is not supported by your system"
print_config HAVE_ mpxp_config.h mpxp_config.mak malloc

check_func2 malloc.h memalign
disabled memalign	&& die "memalign is not supported by your system"
print_config HAVE_ mpxp_config.h mpxp_config.mak memalign

check_func2 alloca.h alloca
print_config HAVE_ mpxp_config.h mpxp_config.mak alloca

require2 sys_soundcard_h sys/soundcard.h SNDCARD_SB
print_config HAVE_ mpxp_config.h mpxp_config.mak sys_soundcard_h
require2 soundcard_h soundcard.h SNDCARD_SB
print_config HAVE_ mpxp_config.h mpxp_config.mak soundcard_h

# XXX: FIXME, add runtime checking
echocheck "linux devfs"
echores "$linux_devfs"

# Checking for localization ...
echocheck "language"
linguas=$language
test -z $linguas && linguas=`echo $LANG | sed 's/^\([^_]*\).*$/\1/'`
if test -f "nls/mpxp_help-$linguas.h" ; then
  echores "$linguas"
else
  echores "$linguas not found, using en"
  linguas="en"
fi
mpxp_help="nls/mpxp_help-$linguas.h"
test -f nls/mpxp_help-$linguas.h || die "nls/mpxp_help-$linguas.h not found"
echo "#define I18N_LANGUAGE \"$linguas\"" >>mpxp_config.h

enabled gpl_only && disable win32loader

if win32 || ! x86_32 ; then
disable win32loader
fi
win32 && add_ldflags -lkernel32
print_config ENABLE_ mpxp_config.h mpxp_config.mak win32loader

echo -n "win32 dll's ... "
if test -z "$win32libdir" ; then
  for I in /usr/local/lib/win32 /usr/lib/win32 ; do
    if test -d "$I" ; then
      win32libdir="$I"
      break;
    fi;
  done
fi
echo "$win32libdir"
echo "#define WIN32_PATH \"$win32libdir\"" >>mpxp_config.h

#########
# VIDEO #
#########
check_pkg x11 x11
enabled x11 && require2 x11 "X11/Xlib.h X11/Xutil.h" XCreateWindow -lXext
print_config HAVE_ mpxp_config.h mpxp_config.mak x11
enabled x11 && vomodules="x11 $vomodules" || novomodules="x11 $novomodules"

disabled x11	&& disable xdpms
enabled xdpms	&& require2 xdpms "X11/Xlib.h X11/extensions/dpms.h" DPMSQueryExtension
disabled xdpms	&& require2 xdpms "X11/Xlib.h X11/extensions/dpms.h" DPMSQueryExtension -lXdpms
print_config HAVE_ mpxp_config.h mpxp_config.mak xdpms

disabled x11	&& disable xv
enabled xv	&& require2 xv "X11/Xlib.h X11/extensions/Xvlib.h" XvGetPortAttribute -lXv
print_config HAVE_ mpxp_config.h mpxp_config.mak xv
enabled xv	&& vomodules="xv $vomodules" || novomodules="xv $novomodules"

disabled x11	&& disable xinerama
enabled xinerama	&& require2 xinerama "X11/Xlib.h X11/extensions/Xinerama.h" XineramaIsActive -lXinerama
print_config HAVE_ mpxp_config.h mpxp_config.mak xinerama

if win32 ; then
enabled opengl	&& require2 opengl "windows.h GL/gl.h" wglCreateContext -lopengl32 -lgdi32
else
disabled x11	&& disable opengl
enabled opengl  && require2 opengl "GL/gl.h GL/glx.h GL/glut.h" glutInitWindowSize -lglut -lGL -lGLU
fi
print_config HAVE_ mpxp_config.h mpxp_config.mak opengl
enabled opengl	&& vomodules="opengl $vomodules" || novomodules="opengl $novomodules"

# Note: the -lXxf86vm library is the VideoMode extension and though it's not
# needed for DGA, AFAIK every distribution packages together with DGA stuffs
# named 'X extensions' or something similar.
# This check may be useful for future mplayerxp versions (to change resolution)
# If you run into problems, remove '-lXxf86vm'.
disabled x11	&& disable xf86vm
enabled xf86vm	&& require2 xf86vm "X11/Xlib.h X11/extensions/xf86vmode.h" XF86VidModeQueryExtension -lXxf86vm
print_config HAVE_ mpxp_config.h mpxp_config.mak xf86vm

disabled x11	&& disable dga

enabled fbdev	&& require2 fbdev "sys/ioctl.h linux/fb.h" ioctl
print_config HAVE_ mpxp_config.h mpxp_config.mak fbdev
enabled fbdev	&& vomodules="fbdev $vomodules" || novomodules="fbdev $novomodules"
if test "$fbdev_nocopy" = yes ; then
    def_fbdev_nocopy='#define USE_CONVERT2FB 1'
fi

if enabled png; then
require2 png png.h PNG_LIBPNG_VER_STRING -lpng
print_config HAVE_ mpxp_config.h mpxp_config.mak png
disabled png	&& require2 libpng_png libpng/png.h PNG_LIBPNG_VER_STRING -lpng -lm
print_config HAVE_ mpxp_config.h mpxp_config.mak libpng_png
enabled libpng_png	&& enable png
fi
enabled png	&& vomodules="png $vomodules" || novomodules="png $novomodules"

enabled jpg	&& require2 jpeg "stdio.h stdlib.h setjmp.h string.h jpeglib.h" jpeg_write_scanlines -ljpeg
print_config HAVE_ mpxp_config.h mpxp_config.mak jpeg
enabled jpeg	&& vomodules="jpeg $vomodules" || novomodules="jpeg $novomodules"

x86_32 || disable vesa
_vesa=$vesa
enabled vesa	&& require3 vesa "asm/vm86.h string.h" VIF_MASK memset
if disabled vesa ; then
vesa=$_vesa
enabled vesa	&& require3 vesa "asm/vm86.h string.h" X86_EFLAGS_VIF memset
fi
print_config HAVE_ mpxp_config.h mpxp_config.mak vesa
enabled vesa	&& vomodules="vesa $vomodules" || novomodules="vesa $novomodules"

#################
# VIDEO + AUDIO #
#################

enabled sdl && check_pkg sdl sdl
enabled sdl && require2 sdl SDL/SDL.h SDL_CreateYUVOverlay
print_config HAVE_ mpxp_config.h mpxp_config.mak sdl
disabled sdl && disable sdl_image
if enabled sdl; then
enabled sdl_image	&& require2 sdl_image SDL/SDL_image.h IMG_Load_RW -lSDL_image
print_config HAVE_ mpxp_config.h mpxp_config.mak sdl_image
fi
enabled sdl	&& aomodules="sdl $aomodules" || noaomodules="sdl $noaomodules"
enabled sdl	&& vomodules="sdl $vomodules" || novomodules="sdl $novomodules"
enabled sdl_image && vomodules="sdl_image $vomodules" || novomodules="sdl_image $novomodules"

enabled libcdio	&& require2 libcdio "cdio/cdio.h" cdio_read_mode2_sectors -lcdio
print_config HAVE_ mpxp_config.h mpxp_config.mak libcdio

enabled libcdio && require2 libcdio_cdda "cdio/cdda.h" cdio_cddap_read -lcdio_cdda
print_config HAVE_ mpxp_config.h mpxp_config.mak libcdio_cdda
enabled libcdio_cdda	&& inputmodules="cdda $inputmodules" || noinputmodules="cdda $noinputmodules"

#########
# AUDIO #
#########

enabled ossaudio	&& require2 ossaudio sys/soundcard.h SNDCTL_DSP_SETFRAGMENT
oss_audio=$ossaudio
print_config USE_ mpxp_config.h mpxp_config.mak oss_audio
enabled ossaudio	&& aomodules="oss $aomodules" || noaomodules="oss $noaomodules"
if test "$linux_devfs" = yes; then
    def_ossaudio_devdsp='#define PATH_DEV_DSP "/dev/sound/dsp"'
    def_ossaudio_devmixer='#define PATH_DEV_MIXER "/dev/sound/mixer"'
else
    def_ossaudio_devdsp='#define PATH_DEV_DSP "/dev/dsp"'
    def_ossaudio_devmixer='#define PATH_DEV_MIXER "/dev/mixer"'
fi

enabled alsa && require2 alsa alsa/asoundlib.h SND_LIB_MAJOR -lasound
print_config HAVE_ mpxp_config.h mpxp_config.mak alsa
enabled alsa	&& aomodules="alsa $aomodules" || noaomodules="alsa $noaomodules"

# It seems that aRts doesn't support pkg-config
enabled arts && check_cflags $(artsc-config --cflags) && add_cflags $(artsc-config --cflags) || disable arts
enabled arts && check_ldflags $(artsc-config --libs) && add_extralibs $(artsc-config --libs) || disable arts
enabled arts && require2 arts artsc.h arts_write -lartsc
print_config HAVE_ mpxp_config.h mpxp_config.mak arts
enabled arts	&& aomodules="arts $aomodules" || noaomodules="arts $noaomodules"

check_pkg esd esound
enabled esd && require2 esd esd.h esd_open_sound
print_config HAVE_ mpxp_config.h mpxp_config.mak esd
enabled esd	&& aomodules="esd $aomodules" || noaomodules="esd $noaomodules"

enabled openal && require2 openal AL/al.h alSourceQueueBuffers -lopenal
print_config HAVE_ mpxp_config.h mpxp_config.mak openal
enabled openal && aomodules="openal $aomodules" || noaomodules="openal $noaomodules"

enabled nas && require2 nas audio/audiolib.h AuOpenServer -laudio
print_config HAVE_ mpxp_config.h mpxp_config.mak nas
enabled nas && aomodules="nas $aomodules" || noaomodules="nas $noaomodules"

check_pkg jack jack
enabled jack && require2 jack jack/jack.h jack_client_open
print_config HAVE_ mpxp_config.h mpxp_config.mak jack
enabled jack && aomodules="jack $aomodules" || noaomodules="jack $noaomodules"

enabled libdvdread	&& require2 libdvdread "stdint.h dvdread/dvd_reader.h dvdread/ifo_types.h dvdread/ifo_read.h dvdread/nav_read.h" DVDOpenFile -ldvdread
dvdread=$libdvdread
print_config USE_ mpxp_config.h mpxp_config.mak dvdread
enabled libdvdread	&& inputmodules="libdvdread $inputmodules" || noinputmodules="libdvdread $noinputmodules"

enabled libdvdnav	&& require2 libdvdnav dvdnav/dvdnav.h dvdnav_set_PGC_positioning_flag -ldvdnav
dvdnav=$libdvdnav
print_config USE_ mpxp_config.h mpxp_config.mak dvdnav
enabled libdvdnav	&& inputmodules="libdvdnav $inputmodules" || noinputmodules="libdvdnav $noinputmodules"

enabled libvcd && require2 libvcd libvcd/info.h vcdinfo_open -lvcdinfo
print_config USE_ mpxp_config.h mpxp_config.mak libvcd
enabled libvcd	&& inputmodules="libvcd $inputmodules" || noinputmodules="libvcd $noinputmodules"

enabled libdv && check_pkg libdv libdv
enabled libdv && require2 libdv "libdv/dv.h" dv_encoder_new -ldv
print_config HAVE_ mpxp_config.h mpxp_config.mak libdv
enabled libdv	&& inputmodules="libdv $inputmodules" || noinputmodules="libdv $noinputmodules"

enabled fastmemcpy	&& x86	|| disable fastmemcpy
print_config USE_ mpxp_config.h mpxp_config.mak fastmemcpy

enabled tv && print_config USE_ mpxp_config.h mpxp_config.mak tv
enabled tv	&& inputmodules="tv $inputmodules" || noinputmodules="tv $noinputmodules"

print_config HAVE_ mpxp_config.h mpxp_config.mak audio_select

enabled libvorbis && check_pkg libvorbis vorbis
print_config HAVE_ mpxp_config.h mpxp_config.mak libvorbis
enabled libvorbis && inputmodules="libvorbis $inputmodules" || noinputmodules="libvorbis $noinputmodules"

enabled libtheora && check_pkg libtheora theora
print_config HAVE_ mpxp_config.h mpxp_config.mak libtheora
enabled libtheora && inputmodules="libtheora $inputmodules" || noinputmodules="libtheora $noinputmodules"

enabled libbz2 && require2 libbz2 bzlib.h BZ2_bzlibVersion -lbz2 || disable libbz2
print_config HAVE_ mpxp_config.h mpxp_config.mak libbz2

CFLAGS="$CFLAGS -W -Wall -Wextra -Wshadow"
# Thread support
if linux ; then
  CFLAGS="$CFLAGS -D_REENTRANT"
elif bsd ; then
  # FIXME bsd needs this so maybe other OS'es
  CFLAGS="$CFLAGS -D_THREAD_SAFE"
fi

# 64 bit file offsets?
enabled largefiles	&& CFLAGS="$CFLAGS -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -D__USE_FILE_OFFSET64 -D__USE_LARGEFILE -D_LARGEFILE64_SOURCE"
# Dynamic linking flags 
# (FIXME: 'echocheck "dynamic linking"' above and modify here accordingly)
bsd && add_ldflags "-rdynamic"

enabled dbg23 def_debug='#define MP_DEBUG 1' || def_debug='#undef MP_DEBUG'
enabled dbg23 && check_cflags "-fbounds-check"

# Checking for VIDIX
enabled vidix	&& xxrequire2 vidix "vidix/vidix.h vidix/vidixlibxx.h" Vidix -lvidixxx
print_config CONFIG_ mpxp_config.h mpxp_config.mak vidix
enabled x11	&& enabled vidix	&& vomodules=":vidix $vomodules" || novomodules=":vidix $novomodules"


enabled joystick	&& test linux	|| disable joystick
print_config HAVE_ mpxp_config.h mpxp_config.mak joystick

# pseudo-ramdom names
cat > $TMPC << EOF
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
int main(void) {
    srand(time(0));
    printf("%u %u %u %u %u %u %u %u %u %u\n"
    ,rand(),rand(),rand(),rand(),rand(),rand(),rand(),rand(),rand(),rand()); }
EOF
cc_check || die "Canot generate pseudo-random numbers"

echocheck "generating pseudo-random numbers"
rnd_arr=`$TMPO`
sleep 1
rnd_carr=`$TMPO`
sleep 1
rnd_sarr=`$TMPO`
sleep 1
rnd_farr=`$TMPO`
echores "done"

rnd0=`echo $rnd_arr | cut -d ' ' -f 1`
rnd1=`echo $rnd_arr | cut -d ' ' -f 2`
rnd2=`echo $rnd_arr | cut -d ' ' -f 3`
rnd3=`echo $rnd_arr | cut -d ' ' -f 4`
rnd4=`echo $rnd_arr | cut -d ' ' -f 5`
rnd5=`echo $rnd_arr | cut -d ' ' -f 6`
rnd6=`echo $rnd_arr | cut -d ' ' -f 7`
rnd7=`echo $rnd_arr | cut -d ' ' -f 8`
rnd8=`echo $rnd_arr | cut -d ' ' -f 9`
rnd9=`echo $rnd_arr | cut -d ' ' -f 10`

srnd0=`echo $rnd_sarr | cut -d ' ' -f 1`
srnd1=`echo $rnd_sarr | cut -d ' ' -f 2`
srnd2=`echo $rnd_sarr | cut -d ' ' -f 3`
srnd3=`echo $rnd_sarr | cut -d ' ' -f 4`
srnd4=`echo $rnd_sarr | cut -d ' ' -f 5`
srnd5=`echo $rnd_sarr | cut -d ' ' -f 6`
srnd6=`echo $rnd_sarr | cut -d ' ' -f 7`
srnd7=`echo $rnd_sarr | cut -d ' ' -f 8`
srnd8=`echo $rnd_sarr | cut -d ' ' -f 9`
srnd9=`echo $rnd_sarr | cut -d ' ' -f 10`

frnd0=`echo $rnd_farr | cut -d ' ' -f 1`
frnd1=`echo $rnd_farr | cut -d ' ' -f 2`
frnd2=`echo $rnd_farr | cut -d ' ' -f 3`
frnd3=`echo $rnd_farr | cut -d ' ' -f 4`
frnd4=`echo $rnd_farr | cut -d ' ' -f 5`
frnd5=`echo $rnd_farr | cut -d ' ' -f 6`
frnd6=`echo $rnd_farr | cut -d ' ' -f 7`
frnd7=`echo $rnd_farr | cut -d ' ' -f 8`
frnd8=`echo $rnd_farr | cut -d ' ' -f 9`
frnd9=`echo $rnd_farr | cut -d ' ' -f 10`

crnd0=`echo $rnd_carr | cut -d ' ' -f 1`
crnd1=`echo $rnd_carr | cut -d ' ' -f 2`
crnd2=`echo $rnd_carr | cut -d ' ' -f 3`
crnd3=`echo $rnd_carr | cut -d ' ' -f 4`
crnd4=`echo $rnd_carr | cut -d ' ' -f 5`
crnd5=`echo $rnd_carr | cut -d ' ' -f 6`
crnd6=`echo $rnd_carr | cut -d ' ' -f 7`
crnd7=`echo $rnd_carr | cut -d ' ' -f 8`
crnd8=`echo $rnd_carr | cut -d ' ' -f 9`
crnd9=`echo $rnd_carr | cut -d ' ' -f 10`

crnd0=$(($crnd0 % 255))
crnd1=$(($crnd1 % 255))
crnd2=$(($crnd2 % 255))
crnd3=$(($crnd3 % 255))
crnd4=$(($crnd4 % 255))
crnd5=$(($crnd5 % 255))
crnd6=$(($crnd6 % 255))
crnd7=$(($crnd7 % 255))
crnd8=$(($crnd8 % 255))
crnd9=$(($crnd9 % 255))

if enabled random_name ; then
rsuf=$((($rnd0+$rnd1+$rnd2+$rnd3+$rnd4+$rnd5+$rnd6+$rnd7+$rnd8+$rnd9)%255))
prog_alias="$prog_alias.$rsuf"
fi

CXXFLAGS=$CFLAGS

./version.sh
#############################################################################
echo "Creating mpxp_config.mak"
cat >> mpxp_config.mak << EOF
# -------- Generated by configure -----------

LANG = C
prefix = $prefix
BINDIR = $bindir
DATADIR = $datadir
CONFDIR = $confdir
LIBDIR = $libdir
DESTDIR = $DESTDIR
PROGNAME = $prog_alias
LAVC_SUFFIX=$lavc_libsuffix
AR = ar
CC = $cc
CXX = $cxx
LDCONFIG=$ldconfig
INSTALL=$install
# OPTFLAGS = -O3 $profile $debug $gcov $march $mcpu -pipe -fomit-frame-pointer -ffast-math
OPTFLAGS = $CFLAGS
OPTXXFLAGS = $CXXFLAGS
DEBUG = -DDEBUG
#-- Compile-time random numbers
RND_NUMBER0 = $rnd0
RND_NUMBER1 = $rnd1
RND_NUMBER2 = $rnd2
RND_NUMBER3 = $rnd3
RND_NUMBER4 = $rnd4
RND_NUMBER5 = $rnd5
RND_NUMBER6 = $rnd6
RND_NUMBER7 = $rnd7
RND_NUMBER8 = $rnd8
RND_NUMBER9 = $rnd9

# --- HAZARDOUS STUFF

EOF
echo "EXTRALIBS=$extralibs" >> mpxp_config.mak
echo "LDFLAGS=$LDFLAGS" >> mpxp_config.mak
echo "LDXXFLAGS=$LDXXFLAGS" >> mpxp_config.mak

#############################################################################
echo "Creating mpxp_config.h"
cat >> mpxp_config.h << EOF
#ifndef MPXP_CONFIG_H
#define MPXP_CONFIG_H 1
/* -------- This file has been automatically generated by configure ---------
   Note: Any changes in it will be lost when you run configure again. */

#define USR_PREFIX "$prefix"

/* define this to use simple idct with patched libavcodec */
#define SIMPLE_IDCT 1

#define USE_OSD 1
#define USE_SUB 1

/* Toggles debugging informations */
$def_debug

/* Common data directory (for fonts, etc) */
#define PROGNAME "$prog_alias"
#define BINDIR "$bindir"
#define DATADIR "$datadir"
#define CONFDIR "$confdir"
#define LIBDIR "$libdir"

/* Define this to enable avg. byte/sec-based AVI sync method by default:
   (use -bps or -nobps commandline option for run-time method selection)
   -bps gives better sync for vbr mp3 audio, it is now default */
#define AVI_SYNC_BPS 1

/* Undefine this if you do not want to select mono audio (left or right)
   with a stereo MPEG layer 2/3 audio stream. The command-line option
   -stereo has three possible values (0 for stereo, 1 for left-only, 2 for
   right-only), with 0 being the default.
   */
#define USE_FAKE_MONO 1

/* define this to use iconv(3) function to codepage conversions */
#if defined(HAVE_GICONV) || defined(HAVE_ICONV)
#define USE_ICONV 1
#endif

/* set up max. outburst. use 65536 for ALSA 0.5, for others 16384 is enough */
#define MAX_OUTBURST 65536

/* set up audio OUTBURST. Do not change this! */
#define OUTBURST 512

/* ASMALIGN */
$def_asmalign

/* Physical size of page on this system */
#define __VM_PAGE_SIZE__ $vm_pagesize
#if defined(__GNUC__) && (__GNUC__ > 3 || __GNUC__ == 3 && __GNUC_MINOR__ > 0)
#define __PAGE_ALIGNED__ __attribute__ ((aligned (__VM_PAGE_SIZE__)))
#else
#define __PAGE_ALIGNED__
#endif

/* Define this if your system has the llrint in "math.h" header file */
#ifndef HAVE_LLRINT
#define HAVE_LLRINT 1
static inline long long int llrint(double x)
{
    return (int)(x + (((int)x-x) < 0 ? -0.5 : 0.5));
}
#endif

/* Define this if your system has the lrint in "math.h" header file */
#ifndef HAVE_LRINT
#define HAVE_LRINT 1
static inline long int lrint(double x)
{
    return (int)(x + (((int)x-x) < 0 ? -0.5 : 0.5));
}
#endif

/* Define this if your system has the HUGE in "math.h" header file */
#ifndef HAVE_HUGE
#define HUGE 3.40282347e+38F
#endif

#define PREFIX "$prefix"

/* Audio output drivers */
$def_ossaudio_devdsp
$def_ossaudio_devmixer

#ifdef sun
#define	DEFAULT_CDROM_DEVICE	"/vol/dev/aliases/cdrom0"
#define DEFAULT_DVD_DEVICE	DEFAULT_CDROM_DEVICE
#else
#define DEFAULT_CDROM_DEVICE    "/dev/cdrom"
#define DEFAULT_DVD_DEVICE	"/dev/dvd"
#endif

/*----------------------------------------------------------------------------
**
** NOTE: Instead of modifying these definitions here, use the
**       --enable/--disable options of the ./configure script!
**       See ./configure --help for details.
**
*---------------------------------------------------------------------------*/

/* libvo options */
$def_fbdev_nocopy


/* Defined to some form of __attribute__ ((...)) if the compiler supports
   a different, more efficient calling convention.  */
#if defined ( __USE_FASTCALL )
 #if defined ( ARCH_X86 )
 /*# define internal_function __attribute__ ((regparm (3), stdcall))*/
 # define __FASTCALL__ __attribute__ ((regparm (3)))
 #elif defined (ARCH_X86_64)
 # define __FASTCALL__ __attribute__ ((regparm (6)))
 #else
 # define __FASTCALL__
 #endif
#else
# define __FASTCALL__
#endif

#ifndef attribute_used
#if defined(__GNUC__) && (__GNUC__ > 3 || __GNUC__ == 3 && __GNUC_MINOR__ > 0)
#    define attribute_used __attribute__((used))
#else
#    define attribute_used
#endif
#endif

#ifndef attribute_unused
#if defined(__GNUC__) && (__GNUC__ > 3 || __GNUC__ == 3 && __GNUC_MINOR__ > 0)
#    define attribute_unused __attribute__((unused))
#else
#    define attribute_unused
#endif
#endif

typedef void any_t;

/* Removes warning about unused arguments */
# define UNUSED(x) ((any_t)(x))

/* Compile-time random numbers */
#define RND_CHAR0 $crnd0
#define RND_CHAR1 $crnd1
#define RND_CHAR2 $crnd2
#define RND_CHAR3 $crnd3
#define RND_CHAR4 $crnd4
#define RND_CHAR5 $crnd5
#define RND_CHAR6 $crnd6
#define RND_CHAR7 $crnd7
#define RND_CHAR8 $crnd8
#define RND_CHAR9 $crnd9

#define RND_NUMBER0 $rnd0
#define RND_NUMBER1 $rnd1
#define RND_NUMBER2 $rnd2
#define RND_NUMBER3 $rnd3
#define RND_NUMBER4 $rnd4
#define RND_NUMBER5 $rnd5
#define RND_NUMBER6 $rnd6
#define RND_NUMBER7 $rnd7
#define RND_NUMBER8 $rnd8
#define RND_NUMBER9 $rnd9

#define RND_STR0 "x$srnd0"
#define RND_STR1 "x$srnd1"
#define RND_STR2 "x$srnd2"
#define RND_STR3 "x$srnd3"
#define RND_STR4 "x$srnd4"
#define RND_STR5 "x$srnd5"
#define RND_STR6 "x$srnd6"
#define RND_STR7 "x$srnd7"
#define RND_STR8 "x$srnd8"
#define RND_STR9 "x$srnd9"


#define RND_RENAME0(a) a ## $frnd0
#define RND_RENAME1(a) a ## $frnd1
#define RND_RENAME2(a) a ## $frnd2
#define RND_RENAME3(a) a ## $frnd3
#define RND_RENAME4(a) a ## $frnd4
#define RND_RENAME5(a) a ## $frnd5
#define RND_RENAME6(a) a ## $frnd6
#define RND_RENAME7(a) a ## $frnd7
#define RND_RENAME8(a) a ## $frnd8
#define RND_RENAME9(a) a ## $frnd9

#define SECURE_NAME0(a) x$srnd0
#define SECURE_NAME1(a) x$srnd1
#define SECURE_NAME2(a) x$srnd2
#define SECURE_NAME3(a) x$srnd3
#define SECURE_NAME4(a) x$srnd4
#define SECURE_NAME5(a) x$srnd5
#define SECURE_NAME6(a) x$srnd6
#define SECURE_NAME7(a) x$srnd7
#define SECURE_NAME8(a) x$srnd8
#define SECURE_NAME9(a) x$srnd9

#endif /* MPXP_CONFIG_H */
EOF

#############################################################################

echo "Creating mpxp_help.h"
cat > mpxp_help.h << EOF
#ifndef __MPXP_HELP_H_INCLUDED
#define __MPXP_HELP_H_INCLUDED 1

#include "$mpxp_help"
#include "nls/mpxp_help-en.h"

#endif
EOF

echo "Creating mpxp_conf_lavc.h"
cat > mpxp_conf_lavc.h << EOF
#ifndef __MPXP_CONF_LAVC_H_INCLUDED__
#define __MPXP_CONF_LAVC_H_INCLUDED__ 1
#include <stdint.h>

#ifdef __cplusplus
extern "C" {
#endif

#define UINT64_C __UINT64_C
#define FF_API_OLD_DECODE_AUDIO 1
#include "$srcdir/../lavc/libavcodec/avcodec.h"
#include "$srcdir/../lavc/libpostproc/postprocess.h"
#include "$srcdir/../lavc/libswscale/swscale.h"
#include "$srcdir/../lavc/libswscale/rgb2rgb.h"
#include "$srcdir/../lavc/libavutil/audioconvert.h"
#include "$srcdir/../lavc/libavutil/fifo.h"
#include "$srcdir/../lavc/libavutil/md5.h"
#include "$srcdir/../lavc/libswresample/swresample.h"
#include "$srcdir/../lavc/libavformat/riff.h"
#include "$srcdir/../lavc/libavformat/avformat.h"
#include "$srcdir/../lavc/libavformat/avio.h"
#include "$srcdir/../lavc/libavformat/url.h"

#ifdef __cplusplus
}
#undef FFMAX
#undef FFMIN
#endif
#endif
EOF
#############################################################################

#FIXME: add something like "Optimizing for: i686 mmx mmx2 sse"
cat << EOF | tee -a $TMPLOG

Config files successfully generated by ./configure !

  Install prefix: $prefix
  Data directory: $datadir
  Config direct.: $confdir

  Enabled optional drivers:
    Input: $inputmodules
    Codecs: $codecmodules
    Audio output: $aomodules
    Video output: $vomodules
  Disabled optional drivers:
EOF
show_homepage "Input:" "noinputmodules" "AUTOCONF_LIST"
show_homepage "Codecs:" "nocodecmodules" "AUTOCONF_LIST"
show_homepage "Audio output:" "noaomodules" "AUTOCONF_LIST"
show_homepage "Video output:" "novomodules" "AUTOCONF_LIST"
cat << EOF | tee -a $TMPLOG
'make' will now compile MPlayerXP and 'make install' will install it.
Note: On non-Linux systems you might need to use 'gmake' instead of 'make'.
EOF

if disabled gomp ; then
cat << EOF | tee -a $TMPLOG
  *** WARNING***: You may improve performance of MPlayerXP by using gcc-4.3+
  with built-in Gnu OpenMP support!!!
EOF
fi

if test -n "$bad_options" ; then
cat << EOF | tee -a $TMPLOG
  WARNING! Ignored/unrecognized options:
  $bad_options

EOF
fi

cat << EOF
Check $TMPLOG if you wonder why an autodetection failed (check whether the
development headers/packages are installed).

EOF

if disabled vidix; then
cat <<EOF
You've disabled VIDIX. Although it provides maximal speedup of playback.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Please visit http://vidix.sf.net to obtain the most recent copy of VIDIX.
EOF
fi

if enabled gcc44_workaround ; then
warning "*** gcc-4.4.0-4.4.3 sometime generates AVX opcodes for -mavx key ignoring -fno-tree-vectorize option.
That breaks current logic of mplayerxp configuring.
It is stronly recommended to use this version of gcc for home purposes only!
Please don't use this compiler to produce distributions of mplayerxp!!! ***"
fi

enabled random_name && echo "Program transform name: $prog_alias"

# Last move:
rmtmps

